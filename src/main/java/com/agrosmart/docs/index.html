<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Agrosmart API – Demo (GitHub Pages)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { --bg:#fff; --muted:#64748b; --line:#e5e7eb; --ink:#0f172a; --code:#0b1020; --code-ink:#d1e7ff; }
        * { box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif; margin: 24px; color: var(--ink); }
        h1 { margin-top: 0; }
        .card { border: 1px solid var(--line); border-radius: 12px; padding: 16px; margin: 16px 0; }
        .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        label { font-size: 14px; color: var(--muted); }
        input { padding: 10px 12px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px; color: var(--ink); }
        input[type="password"] { letter-spacing: .15em; }
        button { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; background: #0ea5e9; color: #fff; font-weight: 600; }
        button.secondary { background: #10b981; }
        button.warn { background: #f59e0b; color: #000; }
        pre { background: var(--code); color: var(--code-ink); padding: 12px; border-radius: 8px; overflow: auto; }
        .hint { color: var(--muted); font-size: .9rem; }
        .grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
        a { color: #2563eb; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
<h1>Agrosmart API – Panel de pruebas</h1>
<p class="hint">Esta página está servida por GitHub Pages (estático) y llama a tu backend Spring Boot (local o Render). Si ves errores CORS, habilita orígenes en tu backend.</p>

<!-- 1) CONFIGURACIÓN -->
<div class="card">
    <h3>1) Configuración</h3>
    <div class="grid">
        <label>Base URL
            <input id="baseUrl" placeholder="http://localhost:8080" />
        </label>
        <label>Usuario
            <input id="user" value="admin" />
        </label>
        <label>Password
            <input id="pass" type="password" value="admin123" />
        </label>
    </div>
    <div class="row" style="margin-top:10px">
        <button class="secondary" id="btnSave">Guardar</button>
        <button class="warn" id="btnClear">Borrar config</button>
    </div>
    <p class="hint" style="margin-top:8px">Tip: también puedes abrir esta página con <code>?base=https://tu-backend.onrender.com</code> para autocompletar la Base URL.</p>
</div>

<!-- 2) ENDPOINTS RÁPIDOS -->
<div class="card">
    <h3>2) Probar endpoints</h3>
    <div class="row">
        <button id="btnPing">GET /api/ping</button>
        <button id="btnListProducts">GET /api/products</button>
        <button id="btnGetProduct1">GET /api/products/1</button>
        <button id="btnCreateProduct">POST /api/products (demo)</button>
        <button id="btnListPO">GET /api/purchase-orders?page=0&size=5</button>
    </div>
</div>

<!-- 3) RESPUESTA -->
<div class="card">
    <h3>Respuesta</h3>
    <pre id="out">— sin llamadas —</pre>
</div>

<!-- 4) RECURSOS -->
<div class="card">
    <h3>Recursos</h3>
    <ul>
        <li><a href="./postman-agrosmart.json" download>Descargar colección Postman (opcional)</a></li>
        <li><a href="https://render.com" target="_blank" rel="noopener">Render (para desplegar el backend)</a></li>
    </ul>
</div>

<script>
    // -------- Utilidades de UI --------
    function $(id){ return document.getElementById(id); }
    function setOut(data){
        const out = $('out');
        if (typeof data === 'string') { out.textContent = data; return; }
        out.textContent = JSON.stringify(data, null, 2);
    }

    // -------- Cargar config inicial --------
    (function init(){
        // desde querystring
        const qs = new URLSearchParams(location.search);
        const baseQS = qs.get('base');
        if (baseQS) localStorage.setItem('baseUrl', baseQS);

        // desde localStorage
        if (localStorage.getItem('baseUrl')) $('baseUrl').value = localStorage.getItem('baseUrl');
        if (localStorage.getItem('user')) $('user').value = localStorage.getItem('user');
        if (localStorage.getItem('pass')) $('pass').value = localStorage.getItem('pass');
    })();

    // -------- Guardar/Borrar config --------
    $('btnSave').addEventListener('click', function(){
        localStorage.setItem('baseUrl', $('baseUrl').value.trim());
        localStorage.setItem('user', $('user').value);
        localStorage.setItem('pass', $('pass').value);
        setOut({ ok:true, message:'Configuración guardada ✅' });
    });

    $('btnClear').addEventListener('click', function(){
        localStorage.removeItem('baseUrl');
        localStorage.removeItem('user');
        localStorage.removeItem('pass');
        $('baseUrl').value = '';
        $('user').value = '';
        $('pass').value = '';
        setOut({ ok:true, message:'Configuración borrada' });
    });

    // -------- Cliente HTTP --------
    function getBase(){
        const b = ($('baseUrl').value || '').trim().replace(/\/+$/, '');
        if (!b) { throw new Error('Configura la Base URL primero.'); }
        return b;
    }

    function authHeader(){
        const u = $('user').value;
        const p = $('pass').value;
        if (!u || !p) return {};
        // concatenación clásica (sin template string) para evitar errores de comillas
        const token = btoa(u + ':' + p);
        return { 'Authorization': 'Basic ' + token };
    }

    async function call(method, path, body){
        try {
            const url = getBase() + path;
            const headers = { 'Accept':'application/json', ...authHeader() };
            const opts = { method, headers };

            if (body) {
                headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(body);
            }

            const res = await fetch(url, opts);
            const text = await res.text();
            let data;
            try { data = JSON.parse(text); } catch { data = text; }
            setOut({ status: res.status + ' ' + res.statusText, method, url, body: body || null, data });
        } catch (e) {
            setOut({ error: true, message: e.message });
        }
    }

    // -------- Acciones de botones --------
    $('btnPing').addEventListener('click', function(){
        call('GET', '/api/ping');
    });
    $('btnListProducts').addEventListener('click', function(){
        call('GET', '/api/products');
    });
    $('btnGetProduct1').addEventListener('click', function(){
        call('GET', '/api/products/1');
    });
    $('btnCreateProduct').addEventListener('click', function(){
        const demo = { name: 'Herbicida Z', sku: 'HERB-Z-001', unit: 'lt', reorderPoint: 5 };
        call('POST', '/api/products', demo);
    });
    $('btnListPO').addEventListener('click', function(){
        call('GET', '/api/purchase-orders?page=0&size=5');
    });
</script>
</body>
</html>